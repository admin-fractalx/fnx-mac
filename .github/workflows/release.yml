name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          # Get latest tag, default to 0.0.0 if none
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST="${LATEST_TAG#v}"

          # Auto-increment patch version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST"
          PATCH=$((PATCH + 1))
          VERSION="${MAJOR}.${MINOR}.${PATCH}"

          echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "TAG=v${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Auto version: ${VERSION} (from ${LATEST_TAG})"

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.version.outputs.TAG }}"
          git push origin "${{ steps.version.outputs.TAG }}"

      - name: Generate Secrets.swift
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > Sources/FnX/Helpers/Secrets.swift << 'SWIFT'
          public enum Secrets {
              public static let openAIAPIKey = "PLACEHOLDER"
          }
          SWIFT
          sed -i '' "s|PLACEHOLDER|${OPENAI_API_KEY}|" Sources/FnX/Helpers/Secrets.swift

      - name: Build release
        run: BUILD_FOR_RELEASE=1 ./build.sh

      - name: Update version in Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.VERSION }}" FnX.app/Contents/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.VERSION }}" FnX.app/Contents/Info.plist

      - name: Sign app
        if: env.SIGNING_IDENTITY != ''
        env:
          SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
        run: |
          codesign --force --options runtime --timestamp -s "${SIGNING_IDENTITY}" FnX.app/Contents/MacOS/FnX
          codesign --force --options runtime --timestamp -s "${SIGNING_IDENTITY}" FnX.app

      - name: Create zip
        run: ditto -c -k --sequesterRsrc --keepParent FnX.app "FnX-${{ steps.version.outputs.VERSION }}.zip"

      - name: Compute SHA256
        id: sha
        run: echo "SHA256=$(shasum -a 256 FnX-${{ steps.version.outputs.VERSION }}.zip | awk '{print $1}')" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          files: FnX-${{ steps.version.outputs.VERSION }}.zip
          body: |
            ## FnX ${{ steps.version.outputs.TAG }}

            ### Install via Homebrew
            ```bash
            brew install --cask admin-fractalx/tap/fnx
            ```

            ### Manual install
            Download `FnX-${{ steps.version.outputs.VERSION }}.zip`, unzip, and move `FnX.app` to `/Applications`.

            ---
            SHA256: `${{ steps.sha.outputs.SHA256 }}`

      - name: Update Homebrew Cask
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          SHA256: ${{ steps.sha.outputs.SHA256 }}
        run: |
          if [ -z "${TAP_GITHUB_TOKEN}" ]; then
            echo "TAP_GITHUB_TOKEN not set — skipping Homebrew tap update"
            exit 0
          fi

          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/admin-fractalx/homebrew-tap.git /tmp/homebrew-tap
          mkdir -p /tmp/homebrew-tap/Casks

          cat > /tmp/homebrew-tap/Casks/fnx.rb << RUBY
          cask "fnx" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/admin-fractalx/fnx-mac/releases/download/v#{version}/FnX-#{version}.zip"
            name "FnX"
            desc "Voice-to-text for macOS — hold Fn to record, release to transcribe"
            homepage "https://github.com/admin-fractalx/fnx-mac"

            depends_on macos: ">= :ventura"

            app "FnX.app"

            zap trash: [
              "~/Library/Preferences/com.fnx.app.plist",
            ]
          end
          RUBY

          cd /tmp/homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/fnx.rb
          git commit -m "Update fnx to ${VERSION}" || echo "No changes"
          git push
